<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>3D-Print-City</title>
  <style>
    body {
      margin: 0;
      font-family: "Microsoft JhengHei", sans-serif;
      background: linear-gradient(135deg, #1f1c2c, #928dab);
      color: white;
      text-align: center;
    }
    header {
      padding: 20px;
      font-size: 36px;
      font-weight: bold;
      background: rgba(0,0,0,0.6);
    }
    nav {
      display: flex;
      justify-content: center;
      gap: 20px;
      background: rgba(255,255,255,0.1);
      padding: 10px;
    }
    nav button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      background: #444;
      color: white;
      cursor: pointer;
      transition: 0.3s;
    }
    nav button:hover { background: #666; }
    section {
      display: none;
      padding: 20px;
      max-width: 1000px;
      margin: auto;
      background: rgba(0,0,0,0.5);
      border-radius: 10px;
      margin-top: 20px;
    }
    section.active { display: block; }
    input, textarea {
      padding: 8px;
      margin: 5px;
      border-radius: 5px;
      border: none;
    }
    #viewer { width: 100%; height: 500px; background: #222; margin-top: 15px; }
  </style>
</head>
<body>
  <!-- 啟動頁 -->
  <div id="startup">
    <h2>請輸入啟動密碼</h2>
    <input type="password" id="startupKey" placeholder="輸入密碼">
    <button onclick="checkStartup()">進入</button>
  </div>

  <!-- 登入註冊頁 -->
  <div id="auth" style="display:none;">
    <h2>登入或註冊</h2>
    <input type="text" id="username" placeholder="帳號"><br>
    <input type="password" id="password" placeholder="密碼"><br>
    <button onclick="login()">登入</button>
    <button onclick="register()">註冊</button>
    <p id="authMsg"></p>
  </div>

  <!-- 主頁 -->
  <div id="main" style="display:none;">
    <header>3D-Print-City</header>
    <nav>
      <button onclick="showPage('modeling')">建模</button>
      <button onclick="showPage('editing')">修圖</button>
      <button onclick="showPage('records')">紀錄</button>
      <button onclick="showPage('profile')">個人畫面</button>
      <button onclick="logout()">登出</button>
    </nav>

    <section id="modeling">
      <h2>建模工具</h2>
      <p>上傳你的 3D 模型檔案 (.stl 或 .obj)：</p>
      <input type="file" id="fileInput" accept=".stl,.obj">
      <div id="viewer"></div>
    </section>

    <section id="editing">
      <h2>修圖工具</h2>
      <p>這裡未來可以加上 3D 模型的細節編輯功能，例如點位調整、幾何圖形追加。</p>
    </section>

    <section id="records">
      <h2>操作紀錄</h2>
      <ul id="recordList"></ul>
    </section>

    <section id="profile">
      <h2>個人畫面</h2>
      <p>輸入密碼可更改背景：</p>
      <input type="password" id="bgKey" placeholder="輸入密碼">
      <button onclick="changeBg()">更改背景</button>
    </section>
  </div>

  <!-- Three.js & 控制器 -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.154.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.154.0/examples/js/loaders/STLLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.154.0/examples/js/loaders/OBJLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.154.0/examples/js/controls/OrbitControls.js"></script>

  <script>
    // 啟動密碼
    function checkStartup() {
      const key = document.getElementById("startupKey").value;
      if (key === "Yuting112919") {
        document.getElementById("startup").style.display = "none";
        document.getElementById("auth").style.display = "block";
      } else {
        alert("密碼錯誤！");
      }
    }

    // 紀錄系統
    function addRecord(msg) {
      const records = JSON.parse(localStorage.getItem("records") || "[]");
      records.push(new Date().toLocaleString() + " - " + msg);
      localStorage.setItem("records", JSON.stringify(records));
      renderRecords();
    }
    function renderRecords() {
      const records = JSON.parse(localStorage.getItem("records") || "[]");
      const list = document.getElementById("recordList");
      if (!list) return;
      list.innerHTML = "";
      records.forEach(r => {
        const li = document.createElement("li");
        li.textContent = r;
        list.appendChild(li);
      });
    }

    // 登入系統
    function register() {
      const u = document.getElementById("username").value;
      const p = document.getElementById("password").value;
      if (!u || !p) return alert("請輸入帳號密碼");
      localStorage.setItem("user:" + u, p);
      document.getElementById("authMsg").innerText = "註冊成功";
      addRecord("註冊帳號：" + u);
    }
    function login() {
      const u = document.getElementById("username").value;
      const p = document.getElementById("password").value;
      if (localStorage.getItem("user:" + u) === p) {
        document.getElementById("auth").style.display = "none";
        document.getElementById("main").style.display = "block";
        addRecord("登入成功：" + u);
        renderRecords();
        showPage('modeling');
      } else {
        document.getElementById("authMsg").innerText = "帳號或密碼錯誤";
      }
    }
    function logout() {
      document.getElementById("main").style.display = "none";
      document.getElementById("auth").style.display = "block";
      addRecord("登出");
    }

    // 分頁切換
    function showPage(id) {
      document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    }

    // 背景修改
    function changeBg() {
      const key = document.getElementById("bgKey").value;
      if (key === "benyoyo555") {
        document.body.style.background = "url('https://picsum.photos/1920/1080?random=1') no-repeat center/cover";
        addRecord("更改背景成功");
      } else {
        alert("密碼錯誤！");
      }
    }

    // 3D Viewer
    const container = document.getElementById("viewer");
    let scene = new THREE.Scene();
    scene.background = new THREE.Color(0x222222);
    let camera = new THREE.PerspectiveCamera(60, container.clientWidth / 500, 0.1, 1000);
    camera.position.set(0, 100, 200);
    let renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(container.clientWidth, 500);
    container.appendChild(renderer.domElement);
    let light1 = new THREE.DirectionalLight(0xffffff, 1);
    light1.position.set(1,1,1).normalize();
    scene.add(light1);
    let light2 = new THREE.AmbientLight(0x404040);
    scene.add(light2);
    let controls = new THREE.OrbitControls(camera, renderer.domElement);

    document.getElementById("fileInput").addEventListener("change", function(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        while(scene.children.length > 2) scene.remove(scene.children[2]);
        if (file.name.toLowerCase().endsWith(".stl")) {
          const loader = new THREE.STLLoader();
          const geometry = loader.parse(e.target.result);
          const material = new THREE.MeshPhongMaterial({ color: 0x0077ff });
          const mesh = new THREE.Mesh(geometry, material);
          scene.add(mesh);
        } else if (file.name.toLowerCase().endsWith(".obj")) {
          const loader = new THREE.OBJLoader();
          const object = loader.parse(e.target.result);
          scene.add(object);
        }
        addRecord("上傳模型：" + file.name);
      };
      if (file.name.toLowerCase().endsWith(".stl")) reader.readAsArrayBuffer(file);
      else reader.readAsText(file);
    });

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();
  </script>
</body>
</html>
